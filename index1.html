<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TLT Max Pain (True Calculation)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f5f7fa;color:#222}
  .container{max-width:1000px;margin:24px auto;background:#fff;border-radius:12px;box-shadow:0 4px 18px rgba(0,0,0,.08);padding:24px}
  h1{margin:0 0 8px}
  .muted{color:#667085;margin:0 0 16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin:16px 0}
  .card{background:#f8fafc;border:1px solid #eef2f7;border-radius:10px;padding:12px}
  .label{color:#475467;font-size:12px}
  .value{font-weight:600}
  .chart-wrap{position:relative;height:420px;margin:8px 0 16px}
  .loading,.error{padding:14px;border-radius:10px;text-align:center}
  .loading{background:#eef6ff;color:#184e9e}
  .error{background:#fff1f1;color:#9b1c1c;border:1px solid #f7d8d8}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:8px 10px;border-bottom:1px solid #eef2f7;text-align:right}
  th:first-child,td:first-child{text-align:left}
  th{background:#fbfcfe;color:#475467;font-weight:600}
</style>
</head>
<body>
<div class="container">
  <h1>TLT Max Pain</h1>
  <p class="muted">Nearest expiry, computed by minimizing total intrinsic payout across all strikes.</p>

  <div id="notice" class="loading">Loading options chain…</div>
  <div id="error" class="error" style="display:none"></div>

  <div class="grid" id="info" style="display:none">
    <div class="card">
      <div class="label">Symbol</div>
      <div class="value" id="sym">—</div>
    </div>
    <div class="card">
      <div class="label">Current Price</div>
      <div class="value" id="px">—</div>
    </div>
    <div class="card">
      <div class="label">Nearest Expiration</div>
      <div class="value" id="exp">—</div>
    </div>
    <div class="card">
      <div class="label">Max Pain (settlement)</div>
      <div class="value" id="mp">—</div>
    </div>
  </div>

  <div class="chart-wrap"><canvas id="chart"></canvas></div>

  <div class="card">
    <div class="label" style="margin-bottom:6px">Open Interest by Strike (nearest expiry)</div>
    <table>
      <thead>
        <tr>
          <th>Strike</th>
          <th>Calls OI</th>
          <th>Puts OI</th>
          <th>Net OI (Calls−Puts)</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
(async () => {
  const SYMBOL = 'TLT';

  // If you fetch from the browser, Yahoo will likely block via CORS.
  // Option A (quick test): use a public CORS proxy below (unreliable).
  // Option B (recommended): deploy your own tiny proxy and set CORS_PROXY to it.
  const CORS_PROXY = 'https://cors.isomorphic-git.org/'; // '' if you fetch server-side

  const el = (id) => document.getElementById(id);
  const notice = el('notice');
  const errBox = el('error');

  const buildURL = (url) => CORS_PROXY ? CORS_PROXY + url : url;

  try {
    // 1) Current price
    const chartUrl = buildURL(`https://query1.finance.yahoo.com/v8/finance/chart/${SYMBOL}?range=1d&interval=1d`);
    const chartRes = await axios.get(chartUrl);
    const meta = chartRes?.data?.chart?.result?.[0]?.meta || {};
    const current = Number(meta.regularMarketPrice ?? meta.previousClose ?? NaN);

    // 2) Expirations
    const expRootUrl = buildURL(`https://query2.finance.yahoo.com/v7/finance/options/${SYMBOL}`);
    const expRoot = await axios.get(expRootUrl);
    const oc0 = expRoot?.data?.optionChain?.result?.[0];
    if (!oc0) throw new Error('No optionChain result (CORS or symbol issue).');
    const expiries = oc0.expirationDates;
    if (!expiries?.length) throw new Error('No expirations returned.');
    const nearest = expiries[0];

    // 3) Nearest expiry chain
    const chainUrl = buildURL(`https://query2.finance.yahoo.com/v7/finance/options/${SYMBOL}?expirationDate=${nearest}`);
    const chainRes = await axios.get(chainUrl);
    const chain = chainRes?.data?.optionChain?.result?.[0]?.options?.[0];
    if (!chain) throw new Error('No options for nearest expiration.');

    const calls = chain.calls || [];
    const puts  = chain.puts  || [];

    // Build strike universe and OI maps
    const callOI = new Map();
    const putOI  = new Map();
    const strikesSet = new Set();

    for (const c of calls) {
      const k = Number(c.strike);
      const oi = Number(c.openInterest || 0);
      strikesSet.add(k);
      callOI.set(k, (callOI.get(k) || 0) + oi);
    }
    for (const p of puts) {
      const k = Number(p.strike);
      const oi = Number(p.openInterest || 0);
      strikesSet.add(k);
      putOI.set(k, (putOI.get(k) || 0) + oi);
    }

    const strikes = Array.from(strikesSet).sort((a,b)=>a-b);

    // True max pain: minimize total intrinsic payout (×100)
    const points = strikes.map(S => {
      let payout = 0;
      // Calls: OI * max(0, S - K)
      for (const [K, oi] of callOI) payout += oi * Math.max(0, S - K);
      // Puts: OI * max(0, K - S)
      for (const [K, oi] of putOI)  payout += oi * Math.max(0, K - S);
      return { x: S, y: payout * 100 }; // 100 shares/contract
    });

    if (!points.length) throw new Error('No strikes to compute.');

    // Find S* with minimal payout
    let minIdx = 0, minVal = points[0].y;
    for (let i=1;i<points.length;i++){
      if (points[i].y < minVal){ minVal = points[i].y; minIdx = i; }
    }
    const maxPain = points[minIdx].x;

    // UI
    notice.style.display = 'none';
    el('info').style.display = 'grid';
    el('sym').textContent = SYMBOL;
    el('px').textContent  = isFinite(current) ? `$${current.toFixed(2)}` : '—';
    el('exp').textContent = new Date(nearest*1000).toLocaleDateString(undefined, {year:'numeric',month:'short',day:'2-digit'});
    el('mp').textContent  = `$${maxPain.toFixed(2)}`;

    // Chart (numeric x, vertical line at maxPain)
    const ctx = document.getElementById('chart').getContext('2d');
    const vline = {
      id: 'vline',
      afterDatasetsDraw(chart, args, pluginOptions){
        const {ctx, scales:{x,y}} = chart;
        const px = x.getPixelForValue(maxPain);
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(px, y.top);
        ctx.lineTo(px, y.bottom);
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'rgba(220, 38, 38, 0.9)';
        ctx.stroke();
        ctx.fillStyle = 'rgba(220, 38, 38, 1)';
        ctx.textAlign = 'center';
        ctx.fillText(`Max Pain $${maxPain.toFixed(2)}`, px, y.top + 12);
        ctx.restore();
      }
    };

    new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [{
          label: 'Total Intrinsic Payout (≈ $)',
          data: points,           // [{x: strike, y: payout}]
          parsing: false,         // use x/y directly
          borderWidth: 2,
          fill: false,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'Strike' },
            ticks: { callback: v => `$${Number(v).toFixed(0)}` }
          },
          y: {
            title: { display: true, text: 'Total Payout (contracts × $)' },
            beginAtZero: true
          }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              title: (items)=> items?.[0] ? `Strike $${items[0].raw.x.toFixed(2)}` : '',
              label: (item)=> `Payout ≈ $${item.raw.y.toLocaleString()}`
            }
          }
        }
      },
      plugins: [vline]
    });

    // Table
    const tbody = el('tbody');
    tbody.innerHTML = '';
    for (const k of strikes){
      const c = callOI.get(k) || 0;
      const p = putOI.get(k)  || 0;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="text-align:left">$${k.toFixed(2)}</td>
        <td>${c.toLocaleString()}</td>
        <td>${p.toLocaleString()}</td>
        <td>${(c-p).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    }
  } catch (e) {
    notice.style.display = 'none';
    errBox.style.display = 'block';
    errBox.textContent = `Failed to load data. Likely CORS. ${e.message}`;
  }
})();
</script>
</body>
</html>
